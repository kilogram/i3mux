#!/usr/bin/env bash
# i3mux-rofi - Simple rofi interface for i3mux
#
# Usage: Bind to a key in your i3 config:
#   bindsym $mod+m exec /path/to/i3mux-rofi
#
# Edit the menu items to specify host, then select

set -euo pipefail

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/i3mux"
LAST_REMOTE_FILE="$CONFIG_DIR/last_remote"
mkdir -p "$CONFIG_DIR"

get_last_remote() {
    [ -f "$LAST_REMOTE_FILE" ] && cat "$LAST_REMOTE_FILE" || echo ""
}

save_last_remote() {
    echo "$1" > "$LAST_REMOTE_FILE"
}

notify() {
    command -v notify-send &>/dev/null && notify-send "i3mux" "$1"
}

get_all_sessions() {
    {
        i3mux sessions 2>/dev/null | grep -v "^Sessions on" | sed 's/^[[:space:]]*//' | sed 's/^/[local] /' || true
        local last_remote=$(get_last_remote)
        if [ -n "$last_remote" ]; then
            i3mux sessions --remote "$last_remote" 2>/dev/null | grep -v "^Sessions on" | sed 's/^[[:space:]]*//' | sed "s/^/[$last_remote] /" || true
        fi
    } | grep -v "^No sessions"
}

# Build menu
last_remote=$(get_last_remote)
menu="Detach
Attach
list
kill"

# Add quick activate for last remote if exists
if [ -n "$last_remote" ]; then
    menu="$last_remote
$menu"
fi

# Show menu - user can edit entries or select as-is
selection=$(echo "$menu" | rofi -dmenu -p "i3mux" -mesg "Empty=local, type hostname for remote, or select action")

# Empty selection = activate local
[ -z "$selection" ] && selection="local"

# Parse selection
case "$selection" in
    Attach)
        sessions=$(get_all_sessions)
        [ -z "$sessions" ] && { notify "No sessions available"; exit 0; }

        selected_session=$(echo "$sessions" | rofi -dmenu -p "Select Session")
        [ -z "$selected_session" ] && exit 0

        if [[ "$selected_session" =~ ^\[local\]\ (.+)\ -\ (.+)$ ]]; then
            if ! error=$(i3mux attach --session "${BASH_REMATCH[1]}" 2>&1); then
                rofi -e "Failed to attach: $error"
            fi
        elif [[ "$selected_session" =~ ^\[(.+)\]\ (.+)\ -\ (.+)$ ]]; then
            save_last_remote "${BASH_REMATCH[1]}"
            if ! error=$(i3mux attach --remote "${BASH_REMATCH[1]}" --session "${BASH_REMATCH[2]}" 2>&1); then
                rofi -e "Failed to attach: $error"
            fi
        fi
        ;;

    Detach)
        if error=$(i3mux detach 2>&1); then
            notify "Session detached"
        else
            rofi -e "Failed to detach: $error"
        fi
        ;;

    list)
        sessions=$(get_all_sessions)
        [ -z "$sessions" ] && { rofi -e "No sessions found"; exit 0; }
        echo "$sessions" | rofi -dmenu -p "All Sessions" -mesg "Read-only" || true
        ;;

    kill)
        sessions=$(get_all_sessions)
        [ -z "$sessions" ] && { rofi -e "No sessions to kill"; exit 0; }

        selected_session=$(echo "$sessions" | rofi -dmenu -p "Select Session to Kill")
        [ -z "$selected_session" ] && exit 0

        confirm=$(echo -e "Yes\nNo" | rofi -dmenu -p "Really kill?")
        [ "$confirm" != "Yes" ] && exit 0

        if [[ "$selected_session" =~ ^\[local\]\ (.+)\ -\ (.+)$ ]]; then
            i3mux kill --session "${BASH_REMATCH[1]}" && notify "Killed"
        elif [[ "$selected_session" =~ ^\[(.+)\]\ (.+)\ -\ (.+)$ ]]; then
            i3mux kill --remote "${BASH_REMATCH[1]}" --session "${BASH_REMATCH[2]}" && notify "Killed"
        fi
        ;;

    local)
        # Special case: typing "local" activates local session
        if ! error=$(i3mux activate 2>&1); then
            rofi -e "Failed to activate local: $error"
        fi
        ;;

    *)
        # Anything else is assumed to be a remote host to activate
        save_last_remote "$selection"
        if ! error=$(i3mux activate --remote "$selection" 2>&1); then
            rofi -e "Failed to activate $selection: $error"
        fi
        ;;
esac
